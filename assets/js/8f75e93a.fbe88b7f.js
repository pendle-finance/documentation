"use strict";(self.webpackChunkpendle_documentation=self.webpackChunkpendle_documentation||[]).push([[9918],{3905:(e,t,a)=>{a.d(t,{Zo:()=>o,kt:()=>d});var n=a(7294);function s(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){s(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,s=function(e,t){if(null==e)return{};var a,n,s={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(s[a]=e[a]);return s}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(s[a]=e[a])}return s}var p=n.createContext({}),m=function(e){var t=n.useContext(p),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},o=function(e){var t=m(e.components);return n.createElement(p.Provider,{value:t},e.children)},c="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},N=n.forwardRef((function(e,t){var a=e.components,s=e.mdxType,r=e.originalType,p=e.parentName,o=i(e,["components","mdxType","originalType","parentName"]),c=m(a),N=s,d=c["".concat(p,".").concat(N)]||c[N]||u[N]||r;return a?n.createElement(d,l(l({ref:t},o),{},{components:a})):n.createElement(d,l({ref:t},o))}));function d(e,t){var a=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var r=a.length,l=new Array(r);l[0]=N;var i={};for(var p in t)hasOwnProperty.call(t,p)&&(i[p]=t[p]);i.originalType=e,i[c]="string"==typeof e?e:s,l[1]=i;for(var m=2;m<r;m++)l[m]=a[m];return n.createElement.apply(null,l)}return n.createElement.apply(null,a)}N.displayName="MDXCreateElement"},724:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>p,contentTitle:()=>l,default:()=>u,frontMatter:()=>r,metadata:()=>i,toc:()=>m});var n=a(7462),s=(a(7294),a(3905));const r={},l="Settlement",i={unversionedId:"Boros/Mechanics/Settlement",id:"Boros/Mechanics/Settlement",title:"Settlement",description:"In Boros, settlement refers to position update when a trade happens (e.g. market order placed, limit order filled) and the periodic floating payment.",source:"@site/docs/Boros/Mechanics/Settlement.md",sourceDirName:"Boros/Mechanics",slug:"/Boros/Mechanics/Settlement",permalink:"/Boros/Mechanics/Settlement",draft:!1,tags:[],version:"current",frontMatter:{}},p={},m=[{value:"Trade Settlement",id:"trade-settlement",level:3},{value:"Floating Rate Settlement",id:"floating-rate-settlement",level:3},{value:"Algorithm",id:"algorithm",level:2},{value:"Notes",id:"notes",level:2}],o={toc:m},c="wrapper";function u(e){let{components:t,...a}=e;return(0,s.kt)(c,(0,n.Z)({},o,a,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"settlement"},"Settlement"),(0,s.kt)("p",null,"In Boros, settlement refers to position update when a trade happens (e.g. market order placed, limit order filled) and the periodic floating payment."),(0,s.kt)("h3",{id:"trade-settlement"},"Trade Settlement"),(0,s.kt)("p",null,"When a trade is executed (e.g., a market order fills against limit orders), traders must pay an upfront fixed cost immediately. This upfront cost represents the present value of the fixed rate component of the interest rate swap for the remaining time to maturity."),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Formula:")),(0,s.kt)("div",{className:"math math-display"},(0,s.kt)("span",{parentName:"div",className:"katex-display"},(0,s.kt)("span",{parentName:"span",className:"katex"},(0,s.kt)("span",{parentName:"span",className:"katex-mathml"},(0,s.kt)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"},(0,s.kt)("semantics",{parentName:"math"},(0,s.kt)("mrow",{parentName:"semantics"},(0,s.kt)("mtext",{parentName:"mrow"},"Upfront\xa0Cost"),(0,s.kt)("mo",{parentName:"mrow"},"="),(0,s.kt)("mtext",{parentName:"mrow"},"Order\xa0Size"),(0,s.kt)("mo",{parentName:"mrow"},"\xd7"),(0,s.kt)("mtext",{parentName:"mrow"},"Order\xa0Rate"),(0,s.kt)("mo",{parentName:"mrow"},"\xd7"),(0,s.kt)("mfrac",{parentName:"mrow"},(0,s.kt)("mtext",{parentName:"mfrac"},"Time\xa0to\xa0Maturity"),(0,s.kt)("mtext",{parentName:"mfrac"},"YEAR"))),(0,s.kt)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"\\text{Upfront Cost} = \\text{Order Size} \\times \\text{Order Rate} \\times \\frac{\\text{Time to Maturity}}{\\text{YEAR}}")))),(0,s.kt)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,s.kt)("span",{parentName:"span",className:"base"},(0,s.kt)("span",{parentName:"span",className:"strut",style:{height:"0.8888799999999999em",verticalAlign:"-0.19444em"}}),(0,s.kt)("span",{parentName:"span",className:"mord text"},(0,s.kt)("span",{parentName:"span",className:"mord"},"Upfront\xa0Cost")),(0,s.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2777777777777778em"}}),(0,s.kt)("span",{parentName:"span",className:"mrel"},"="),(0,s.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2777777777777778em"}})),(0,s.kt)("span",{parentName:"span",className:"base"},(0,s.kt)("span",{parentName:"span",className:"strut",style:{height:"0.77777em",verticalAlign:"-0.08333em"}}),(0,s.kt)("span",{parentName:"span",className:"mord text"},(0,s.kt)("span",{parentName:"span",className:"mord"},"Order\xa0Size")),(0,s.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2222222222222222em"}}),(0,s.kt)("span",{parentName:"span",className:"mbin"},"\xd7"),(0,s.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2222222222222222em"}})),(0,s.kt)("span",{parentName:"span",className:"base"},(0,s.kt)("span",{parentName:"span",className:"strut",style:{height:"0.77777em",verticalAlign:"-0.08333em"}}),(0,s.kt)("span",{parentName:"span",className:"mord text"},(0,s.kt)("span",{parentName:"span",className:"mord"},"Order\xa0Rate")),(0,s.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2222222222222222em"}}),(0,s.kt)("span",{parentName:"span",className:"mbin"},"\xd7"),(0,s.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2222222222222222em"}})),(0,s.kt)("span",{parentName:"span",className:"base"},(0,s.kt)("span",{parentName:"span",className:"strut",style:{height:"2.0463299999999998em",verticalAlign:"-0.686em"}}),(0,s.kt)("span",{parentName:"span",className:"mord"},(0,s.kt)("span",{parentName:"span",className:"mopen nulldelimiter"}),(0,s.kt)("span",{parentName:"span",className:"mfrac"},(0,s.kt)("span",{parentName:"span",className:"vlist-t vlist-t2"},(0,s.kt)("span",{parentName:"span",className:"vlist-r"},(0,s.kt)("span",{parentName:"span",className:"vlist",style:{height:"1.3603299999999998em"}},(0,s.kt)("span",{parentName:"span",style:{top:"-2.314em"}},(0,s.kt)("span",{parentName:"span",className:"pstrut",style:{height:"3em"}}),(0,s.kt)("span",{parentName:"span",className:"mord"},(0,s.kt)("span",{parentName:"span",className:"mord text"},(0,s.kt)("span",{parentName:"span",className:"mord"},"YEAR")))),(0,s.kt)("span",{parentName:"span",style:{top:"-3.23em"}},(0,s.kt)("span",{parentName:"span",className:"pstrut",style:{height:"3em"}}),(0,s.kt)("span",{parentName:"span",className:"frac-line",style:{borderBottomWidth:"0.04em"}})),(0,s.kt)("span",{parentName:"span",style:{top:"-3.677em"}},(0,s.kt)("span",{parentName:"span",className:"pstrut",style:{height:"3em"}}),(0,s.kt)("span",{parentName:"span",className:"mord"},(0,s.kt)("span",{parentName:"span",className:"mord text"},(0,s.kt)("span",{parentName:"span",className:"mord"},"Time\xa0to\xa0Maturity"))))),(0,s.kt)("span",{parentName:"span",className:"vlist-s"},"\u200b")),(0,s.kt)("span",{parentName:"span",className:"vlist-r"},(0,s.kt)("span",{parentName:"span",className:"vlist",style:{height:"0.686em"}},(0,s.kt)("span",{parentName:"span"}))))),(0,s.kt)("span",{parentName:"span",className:"mclose nulldelimiter"}))))))),(0,s.kt)("p",null,"Where:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Order Size"),": The notional amount of the trade"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Order Rate"),": The fixed interest rate agreed upon in the trade"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Time to Maturity"),": ",(0,s.kt)("inlineCode",{parentName:"li"},"maturity - latestFTime")," (in seconds)",(0,s.kt)("ul",{parentName:"li"},(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"maturity"),": The market's expiration timestamp"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"latestFTime"),": The timestamp of the last periodic payment"))),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"YEAR"),": 365 days in seconds (31,536,000)"),(0,s.kt)("li",{parentName:"ul"},"Both ",(0,s.kt)("inlineCode",{parentName:"li"},"maturity")," and ",(0,s.kt)("inlineCode",{parentName:"li"},"latestFTime")," can be retrieved from ",(0,s.kt)("inlineCode",{parentName:"li"},"market.descriptor()"))),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Example:"),"\nFor a market with 8-hour payment periods:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"If current time is 10:00 UTC"),(0,s.kt)("li",{parentName:"ul"},"The ",(0,s.kt)("inlineCode",{parentName:"li"},"latestFTime")," would be 8:00 UTC (the last 8-hour boundary)")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Direction of Payment:")),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Long positions"),": Pay upfront cost to receive floating rate"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Short positions"),": Receive upfront cost to pay floating rate")),(0,s.kt)("h3",{id:"floating-rate-settlement"},"Floating Rate Settlement"),(0,s.kt)("p",null,"Floating rate payments occur periodically (e.g., every 8 hours) to exchange the difference between fixed and floating rates. These payments are calculated based on the position size and the change in the floating index."),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Formula:")),(0,s.kt)("div",{className:"math math-display"},(0,s.kt)("span",{parentName:"div",className:"katex-display"},(0,s.kt)("span",{parentName:"span",className:"katex"},(0,s.kt)("span",{parentName:"span",className:"katex-mathml"},(0,s.kt)("math",{parentName:"span",xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"},(0,s.kt)("semantics",{parentName:"math"},(0,s.kt)("mrow",{parentName:"semantics"},(0,s.kt)("mtext",{parentName:"mrow"},"Floating\xa0Payment"),(0,s.kt)("mo",{parentName:"mrow"},"="),(0,s.kt)("mtext",{parentName:"mrow"},"Signed\xa0Position\xa0Size"),(0,s.kt)("mo",{parentName:"mrow"},"\xd7"),(0,s.kt)("mi",{parentName:"mrow",mathvariant:"normal"},"\u0394"),(0,s.kt)("mtext",{parentName:"mrow"},"Floating\xa0Index")),(0,s.kt)("annotation",{parentName:"semantics",encoding:"application/x-tex"},"\\text{Floating Payment} = \\text{Signed Position Size} \\times \\Delta\\text{Floating Index}")))),(0,s.kt)("span",{parentName:"span",className:"katex-html","aria-hidden":"true"},(0,s.kt)("span",{parentName:"span",className:"base"},(0,s.kt)("span",{parentName:"span",className:"strut",style:{height:"0.8888799999999999em",verticalAlign:"-0.19444em"}}),(0,s.kt)("span",{parentName:"span",className:"mord text"},(0,s.kt)("span",{parentName:"span",className:"mord"},"Floating\xa0Payment")),(0,s.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2777777777777778em"}}),(0,s.kt)("span",{parentName:"span",className:"mrel"},"="),(0,s.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2777777777777778em"}})),(0,s.kt)("span",{parentName:"span",className:"base"},(0,s.kt)("span",{parentName:"span",className:"strut",style:{height:"0.8888799999999999em",verticalAlign:"-0.19444em"}}),(0,s.kt)("span",{parentName:"span",className:"mord text"},(0,s.kt)("span",{parentName:"span",className:"mord"},"Signed\xa0Position\xa0Size")),(0,s.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2222222222222222em"}}),(0,s.kt)("span",{parentName:"span",className:"mbin"},"\xd7"),(0,s.kt)("span",{parentName:"span",className:"mspace",style:{marginRight:"0.2222222222222222em"}})),(0,s.kt)("span",{parentName:"span",className:"base"},(0,s.kt)("span",{parentName:"span",className:"strut",style:{height:"0.8888799999999999em",verticalAlign:"-0.19444em"}}),(0,s.kt)("span",{parentName:"span",className:"mord"},"\u0394"),(0,s.kt)("span",{parentName:"span",className:"mord text"},(0,s.kt)("span",{parentName:"span",className:"mord"},"Floating\xa0Index"))))))),(0,s.kt)("p",null,"Where:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Signed Position Size"),": Positive for long positions, negative for short positions"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"\u0394Floating Index"),": The change in floating index since the last settlement")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Floating Index:"),"\nThe floating index is a cumulative value that represents the total yield earned by 1 unit of the underlying asset since inception."),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Example:"),"\nConsider a perpetual futures funding rate scenario:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"If the funding rate on Binance for the last 8-hour epoch is 0.0001 (0.01%)"),(0,s.kt)("li",{parentName:"ul"},"The \u0394Floating Index would be 0.0001"),(0,s.kt)("li",{parentName:"ul"},"A long position of 100 units would receive: ",(0,s.kt)("inlineCode",{parentName:"li"},"100 \xd7 0.0001 = 0.01")," units"),(0,s.kt)("li",{parentName:"ul"},"A short position of 100 units would receive: ",(0,s.kt)("inlineCode",{parentName:"li"},"-100 \xd7 0.0001 = -0.01")," units (negative payment means paying)")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Fees:"),"\nFloating payments are subject to settlement fees. For detailed fee structure, see ",(0,s.kt)("a",{parentName:"p",href:"/Boros/Mechanics/Fees"},"Fees"),"."),(0,s.kt)("h2",{id:"algorithm"},"Algorithm"),(0,s.kt)("p",null,"In traditional order books, when a market order matches against limit orders, all makers' positions are updated immediately. On-chain, this becomes prohibitively expensive as a single order could match against hundreds or thousands of limit orders, each requiring storage updates. Boros solved this by using a lazy settlement process that defers the position update until the next time users interact with Boros."),(0,s.kt)("p",null,"Since the last time a user interacted with Boros, multiple events may have occurred that affect their position:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"Limit orders could have been filled"),(0,s.kt)("li",{parentName:"ul"},"Floating rate settlements could have occurred"),(0,s.kt)("li",{parentName:"ul"},"These events can interleave in complex patterns")),(0,s.kt)("p",null,"The settlement algorithm processes all pending events in chronological order to ensure correctness:"),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},(0,s.kt)("strong",{parentName:"p"},"Event Collection"),": Gather all events since the user's last settlement:"),(0,s.kt)("ul",{parentName:"li"},(0,s.kt)("li",{parentName:"ul"},"Filled limit orders (grouped by the ",(0,s.kt)("inlineCode",{parentName:"li"},"fTime")," when they were filled)"),(0,s.kt)("li",{parentName:"ul"},"Floating payment settlements at each ",(0,s.kt)("inlineCode",{parentName:"li"},"fTime")," boundary"))),(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},(0,s.kt)("strong",{parentName:"p"},"Chronological Processing"),": Iterate through events by ",(0,s.kt)("inlineCode",{parentName:"p"},"fTime"),":"),(0,s.kt)("pre",{parentName:"li"},(0,s.kt)("code",{parentName:"pre"},"For each fTime period:\n  a. Process all filled orders from that period\n     - Calculate and apply upfront costs\n     - Update position sizes\n  b. Process floating payment for that period\n     - Calculate payment based on position size at settlement time\n     - Apply floating index changes\n  c. Continue to next fTime period\n"))),(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},(0,s.kt)("strong",{parentName:"p"},"State Update"),": After processing all events:"),(0,s.kt)("ul",{parentName:"li"},(0,s.kt)("li",{parentName:"ul"},"Update user's final position size"),(0,s.kt)("li",{parentName:"ul"},"Update user's cash balance"),(0,s.kt)("li",{parentName:"ul"},"Update user's last settlement timestamp")))),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Example Timeline:")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"User last settled: 08:00\nCurrent time: 18:00\n\nEvents to process:\n- 09:30: Limit order filled (100 units)\n- 16:00: Floating payment settlement\n- 17:15: Limit order filled (50 units)\n\nProcessing order:\n1. Process fills from 08:00-16:00 period (100 units)\n2. Process Floating payment at 16:00\n3. Process fills from 16:00-24:00 period (50 units)\n")),(0,s.kt)("h2",{id:"notes"},"Notes"),(0,s.kt)("p",null,"Due to lazy settlement, on-chain state may not reflect the latest position values and balances. Query functions ending with ",(0,s.kt)("inlineCode",{parentName:"p"},"NoSettle")," return raw, unsettled data that may be outdated."),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Getting Up-to-Date Data:")),(0,s.kt)("p",null,"To retrieve current, accurate position information, you must first trigger settlement:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-solidity"},"IMarketHub(marketHub).settleAllAndGet(acc, GetRequest.ZERO, MarketId.ZERO);\n")),(0,s.kt)("p",null,"You can also use the ",(0,s.kt)("a",{parentName:"p",href:"/Boros/Backend/REST%20API"},"REST API"),", which provides accurate, up-to-date data without requiring manual settlement triggers."),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Strategic Position Management:")),(0,s.kt)("p",null,"Floating payments are calculated based on your position size at the exact payment timestamp. This creates an opportunity for strategic position management:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Avoiding Payments"),": You can close or reduce your position before the payment time to minimize floating payments"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Payment Timing"),": Payments occur at regular intervals (e.g., every 8 hours)"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Position Size Matters"),": Only the position size at the payment timestamp is used for calculation")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Oracle Update Delays:")),(0,s.kt)("p",null,"In practice, Floating payments don't occur at the exact period boundaries due to off-chain oracle update delays:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Expected Time"),": Payment for 8:00:00 boundary"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Actual Time"),": Usually occurs ~10 seconds later (e.g., 8:00:10)")))}u.isMDXComponent=!0}}]);